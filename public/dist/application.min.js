"use strict";var ApplicationConfiguration=function(){var applicationModuleName="meanww",applicationModuleVendorDependencies=["ngResource","ngCookies","ngAnimate","ngTouch","ui.router","ui.bootstrap","ui.utils","textAngular","ngFileUpload","dndLists","vcRecaptcha"],registerModule=function(moduleName,dependencies){angular.module(moduleName,dependencies||[]),angular.module(applicationModuleName).requires.push(moduleName)};return{applicationModuleName:applicationModuleName,applicationModuleVendorDependencies:applicationModuleVendorDependencies,registerModule:registerModule}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("!")}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("letters"),ApplicationConfiguration.registerModule("users"),angular.module("core").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("home",{url:"/",templateUrl:"modules/core/views/home.html"}).state("login",{url:"/login",templateUrl:"modules/users/views/authentication/signin.client.view.html"})}]),angular.module("core").controller("HeaderController",["$scope","$state","$location","$modal","Authentication",function($scope,$state,$location,$modal,Authentication){$scope.authentication=Authentication,$scope.isAdmin=function(){return"admin"===$scope.authentication.user.role},$scope.isActive=function(route){return route.indexOf($location.path())>-1},$scope.menuOpened=!1,$scope.toggleMenu=function(event){$scope.menuOpened=!$scope.menuOpened,event.stopPropagation()},window.onclick=function(){$scope.menuOpened&&($scope.menuOpened=!1,$scope.$apply())},$scope.needTutorial=function(){var needTutorial=["command","tracking","agTracking","email","etemplate"],page=$state.current.name;return needTutorial.indexOf(page)>=0},$scope.showTutorial=function(){var page=$state.current.name;"command"===page&&$modal.open({templateUrl:"modules/core/views/adminTutorial.html",controller:"ModalInstanceCtrl",backdrop:"static"})}}]).controller("ModalInstanceCtrl",["$state","$scope","$filter","$modalInstance","Authentication","Agencies",function($state,$scope,$filter,$modalInstance,Authentication,Agencies){$scope.user=Authentication.user,"agTracking"===$state.current.name&&Agencies.get({agencyId:$scope.user.username},function(tf){$scope.dueDate=$filter("date")(tf.due,"fullDate")}),$scope.ok=function(){$modalInstance.close()}}]),angular.module("core").controller("HomeController",["$scope","$location","Authentication",function($scope,$location,Authentication){$scope.user=Authentication.user,$scope.user&&$location.path(0===$scope.user.status?"/ballot":"/thanks")}]),angular.module("letters").config(["$compileProvider",function($compileProvider){$compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|blob|chrome-extension):/)}]),angular.module("letters").config(["$stateProvider",function($stateProvider){$stateProvider.state("command",{url:"/ballot",templateUrl:"modules/letters/views/command.html"}).state("voters",{url:"/voters",templateUrl:"modules/letters/views/labels.html"}).state("adminSettings",{url:"/admin/settings",templateUrl:"modules/letters/views/settings.html"}).state("manageAdmins",{url:"/admin/settings/manage",templateUrl:"modules/letters/views/settings.manage-admins.html"}).state("email",{url:"/admin/email",templateUrl:"modules/emails/views/emails.html"}).state("etemplate",{url:"/admin/email/:template",templateUrl:"modules/emails/views/etemplate.html"}).state("email-success",{url:"/admin/emails/success",templateUrl:"modules/emails/views/esent.html"}).state("thanks",{url:"/thanks",templateUrl:"modules/letters/views/thanks.html"}).state("stats",{url:"/admin/stats",templateUrl:"modules/letters/views/stats.html"})}]),angular.module("letters").controller("CandidateModalCtrl",["$sce","$http","$window","$anchorScroll","$location","$state","$scope","$filter","$modalInstance","Authentication","Users","Articles","candidates",function($sce,$http,$window,$anchorScroll,$location,$state,$scope,$filter,$modalInstance,Authentication,Users,Articles,candidates){$scope.user=Authentication.user,$scope.index=candidates.selected,$scope.max=candidates.all.length-1,$scope.candidate=candidates.all[$scope.index],$scope.viewCandidate=function(direction){$scope.success&&($scope.success=!1),$scope.candidate=candidates.all[$scope.index+=direction],$scope.gotoTop()},$scope.deleteAgency=function(selected){var confirmation=$window.prompt("Please type DELETE to remove "+selected.first_name+" "+selected.last_name+".");"DELETE"===confirmation&&$http["delete"]("/articles/"+selected._id).success(function(response){candidates.all.splice($scope.index,1);var direction=0===$scope.index?0:-1;candidates.all.length>0?($scope.viewCandidate(direction),$scope.max=candidates.all.length-1):$scope.exitModal()}).error(function(response){console.log(response)})},$scope.updateBallot=function(action,selected){if("add"===action)$scope.user.ballot.push(selected._id);else if("remove"===action){var ballot_index=$scope.user.ballot.indexOf(selected._id);$scope.user.ballot.splice(ballot_index,1)}var user=new Users($scope.user);user.$update(function(response){$scope.success=!0,Authentication.user=response,$scope.user=Authentication.user},function(response){$scope.error=response.data.message})},$scope.updateCandidate=function(selected){var candidate=new Articles(selected);candidate.$update(function(response){candidates.all[$scope.index]=response,$scope.editCandidate=!1},function(response){$scope.error=response.data.message})},$scope.gotoTop=function(){$location.hash("top"),$anchorScroll()},$scope.exitModal=function(){$modalInstance.close()}}]),angular.module("letters").controller("CommandController",["$scope","$q","$window","$timeout","$interval","$http","$stateParams","$location","$modal","Authentication","Articles","Globals",function($scope,$q,$window,$timeout,$interval,$http,$stateParams,$location,$modal,Authentication,Articles,Globals){function signup(credentials){$http.post("/articles",credentials).success(function(response){$scope.partners.push(response),console.log(response.message)}).error(function(response){$scope.alert={active:!0,type:"danger",msg:response.message}})}function proccessFile(data){var headers=data.shift(),rows=data,required_fields=["Timestamp","First Name","Last Name","Prep Formatted Name","Bio","Statement","Photo URL"],modal=$modal.open({templateUrl:"modules/letters/views/fileuploadmodal.html",controller:"MappingModalCtrl",backdrop:"static",size:"lg",resolve:{arrays:function(){return{type:"Candidate",required_fields:required_fields,headers:headers}}}});modal.result.then(function(csvheaders){headers={sdate_col:headers.indexOf(csvheaders[0].label),fname_col:headers.indexOf(csvheaders[1].label),lname_col:headers.indexOf(csvheaders[2].label),pname_col:headers.indexOf(csvheaders[3].label),bio_col:headers.indexOf(csvheaders[4].label),state_col:headers.indexOf(csvheaders[5].label),pic_col:headers.indexOf(csvheaders[6].label)},$scope.alert={active:!0,type:"info",msg:"Great! Your tracking forms will appear shortly..."};for(var record=null,i=0;i<rows.length;i++)record=rows[i],signup({submitted:record[headers.sdate_col],first_name:record[headers.fname_col],last_name:record[headers.lname_col],prep_name:record[headers.pname_col],bio:record[headers.bio_col],statement:record[headers.state_col],photo:record[headers.pic_col].length?record[headers.pic_col]:"https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/No_image_available.svg/240px-No_image_available.svg.png"})})}$scope.user=Authentication.user,$scope.user||$location.path("/").replace(),$scope.adminView="user"!==$scope.user.role,$scope.userView="user"===$scope.user.role,$scope.needToUpdate=!1,$scope.alert={active:!1,type:"",msg:""},$scope.find=function(){Globals.query(function(settings){var today=new Date,due_date=_.result(_.find(settings,function(global){return"due_date"===global.setting_name}),"setting_value");due_date=new Date(due_date),due_date>today||"admin"===$scope.user.role?Articles.query(function(users){$scope.partners=users}):$location.path("/thanks").replace()})},$scope.showCandidate=function(selected){$modal.open({templateUrl:"modules/letters/views/candidate.modal.html",controller:"CandidateModalCtrl",backdrop:"static",size:"lg",resolve:{candidates:function(){return{all:$scope.partners,selected:selected}}}})},$scope.handleFileSelect=function(files){if(0===files.length)$scope.alert={active:!0,type:"danger",msg:"Must be a csv file!"};else{var file=files[0];Papa.parse(file,{complete:function(results){proccessFile(results.data),files[0]=void 0}})}},$scope.reviewBallot=function(){$modal.open({templateUrl:"modules/letters/views/myBallot.modal.html",controller:"BallotModalCtrl",backdrop:"static",resolve:{candidates:function(){return $scope.partners}}})}}]),angular.module("letters").controller("MappingModalCtrl",["$state","$scope","$filter","$modalInstance","Authentication","arrays",function($state,$scope,$filter,$modalInstance,Authentication,arrays){$scope.user=Authentication.user,$scope.required_fields=arrays.required_fields,$scope.model={lists:{A:[],B:[]}};for(var i=0;i<arrays.headers.length;++i){var field=$scope.required_fields[i],isValidColumn=arrays.headers.indexOf(field);isValidColumn>-1?$scope.model.lists.B.push({label:arrays.headers[isValidColumn]}):$scope.model.lists.A.push({label:arrays.headers[i]})}$scope.exitModal=function(){$scope.model.lists.B.length===$scope.required_fields.length?$modalInstance.close($scope.model.lists.B):$modalInstance.close()}}]),angular.module("letters").controller("LabelController",["$scope","$window","$interval","$http","$location","$modal","$filter","Authentication",function($scope,$window,$interval,$http,$location,$modal,$filter,Authentication){function signup(credentials){$http.post("/auth/signup",credentials).success(function(response){console.log(response.message)}).error(function(response){$scope.alert={active:!0,type:"danger",msg:response.message}})}function makeid(){for(var text="",possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;12>i;i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text}function downloadCSV(vids){var headers=["VoterID"],csvString=headers.join(",")+"\r\n";_.forEach(vids,function(vid){signup({username:vid}),csvString+=vid+"\r\n"});var date=$filter("date")(new Date,"MM-dd");$scope.fileName="VoterIDs_"+date+".csv";var blob=new Blob([csvString],{type:"text/csv;charset=UTF-8"}),fileURL=$window.URL.createObjectURL(blob);$window.location.href=fileURL}$scope.user=Authentication.user,$scope.user&&"user"!==$scope.user.role||$location.path("/").replace(),$scope.fileURLs=[],$scope.hideDropzone=!1,$scope.alert={active:!1,type:"",msg:""},$scope.generateVoterIDs=function(){for(var vids=[],i=0;i<$scope.voters;i++){var newID=makeid();vids.indexOf(newID)<0&&vids.push(newID)}downloadCSV(vids)}}]),angular.module("letters").controller("BallotModalCtrl",["$http","$window","$anchorScroll","$location","$state","$scope","$filter","$modalInstance","Authentication","Users","candidates",function($http,$window,$anchorScroll,$location,$state,$scope,$filter,$modalInstance,Authentication,Users,candidates){$scope.user=Authentication.user,$scope.candidates=candidates,$scope.viewCandidate=function(direction){$scope.candidate=candidates.all[$scope.index+=direction],$scope.gotoTop()},$scope.deleteAgency=function(selected){var confirmation=$window.prompt("Please type DELETE to remove "+selected.name+".");"DELETE"===confirmation&&$http["delete"]("/articles/"+selected._id).success(function(response){candidates.all.splice($scope.index,1);var direction=0===$scope.index?0:-1;candidates.all.length>0?($scope.viewCandidate(direction),$scope.max=candidates.all.length-1):$scope.exitModal()}).error(function(response){console.log(response)})},$scope.updateBallot=function(selected){var ballot_index=$scope.user.ballot.indexOf(selected._id);$scope.user.ballot.splice(ballot_index,1);var user=new Users($scope.user);user.$update(function(response){$scope.success=!0,Authentication.user=response,$scope.user=Authentication.user},function(response){$scope.error=response.data.message})},$scope.submitBallot=function(){if($scope.user.ballot.length<=6){$scope.user.status=1;var user=new Users($scope.user);user.$update(function(response){$scope.success=!0,Authentication.user=response,$scope.user=Authentication.user,$modalInstance.close(),$location.path("/thanks")},function(response){$scope.error=response.data.message})}},$scope.gotoTop=function(){$location.hash("top"),$anchorScroll()},$scope.exitModal=function(){$modalInstance.close()}}]),angular.module("letters").controller("myController",["$scope","$window","$location","$filter","$http","Authentication","Users","Agencies","Articles","Globals",function($scope,$window,$location,$filter,$http,Authentication,Users,Agencies,Articles,Globals){function signup(credentials){$http.post("/auth/newadmin",credentials).success(function(response){console.log("new admin added"),$scope.newAdmin=!1}).error(function(response){$scope.alert={active:!0,type:"danger",msg:response.message}})}$scope.user=Authentication.user,$scope.user&&"user"!==$scope.user.role||$location.path("/").replace(),$scope.users=Agencies.query(),$scope.viewData=function(tab){"duedate"===tab&&Globals.query(function(settings){$scope.isActive=!1,$scope.new_global={setting_name:"due_date",setting_value:null};var old_global=_.find(settings,function(global){return"due_date"===global.setting_name});old_global&&($scope.isActive=!0,$scope.new_global=old_global)}),$scope.setting=tab,$scope.calendar={startDate:null,endDate:null,opened:{},dateFormat:"MM/dd/yyyy",dateOptions:{showWeeks:!1},open:function($event,calID){$event.preventDefault(),$event.stopPropagation(),$scope.calendar.opened[calID]=!0}}},$scope.saveDueDate=function(){if($scope.isActive){var global=new Globals($scope.new_global);global.$update(function(response){console.log(response.message)},function(response){$scope.error=response.data.message})}else $http.post("/globals",$scope.new_global).success(function(response){console.log(response.message)}).error(function(response){$scope.alert={active:!0,type:"danger",msg:response.message}})},$scope.viewAdmins=function(){$scope.setting="admins",$scope.credentials={}},$scope.saveAdmin=function(){console.log($scope.credentials),signup($scope.credentials)},$scope.resetAll=function(){var confirmation=$window.prompt("Please type FOREVER to wipe all data.");"FOREVER"===confirmation&&$http.get("/users/reset").success(function(response){Authentication.user=response}).error(function(response){$scope.error=response.message})},$scope.resetCandidates=function(){var confirmation=$window.prompt("Please type FOREVER to wipe all candidate data.");"FOREVER"===confirmation&&$http.get("/articles/reset").success(function(response){console.log("success")}).error(function(response){$scope.error=response.message})}}]),angular.module("letters").controller("ManageAdminsController",["$scope","$window","$location","$http","Authentication","Users","Agencies",function($scope,$window,$location,$http,Authentication,Users,Agencies){$scope.user=Authentication.user,$scope.user&&"user"!==$scope.user.role||$location.path("/").replace(),$scope.find=function(){$scope.credentials={},$scope.alert={active:!1,type:"",msg:""},$http.get("/agency/admin").success(function(response){$scope.users=response}).error(function(response){$scope.alert={active:!0,type:"danger",msg:response.message}})},$scope.addAdmin=function(){$http.post("/auth/newadmin",$scope.credentials).success(function(response){$scope.users.push(response),$scope.alert.active&&($scope.alert.active=!1),$scope.credentials=null}).error(function(response){$scope.alert={active:!0,type:"danger",msg:response.message}})},$scope.removeAdmin=function(selected){if($scope.users.length>1){var confirmation=$window.prompt("Type DELETE to remove "+selected.username+"'s account");if("DELETE"===confirmation){var oldAdmin=selected;$http["delete"]("/agency/"+selected._id).success(function(response){$scope.users.splice(_.findIndex($scope.users,oldAdmin),1)}).error(function(response){console.log(response)})}}}}]),angular.module("letters").controller("SummaryController",["$scope","$location","Authentication","Agencies","Articles",function($scope,$location,Authentication,Agencies,Articles){$scope.authentication=Authentication,$scope.authentication.user&&"user"!==$scope.authentication.user.role||$location.path("/").replace(),Articles.query(function(candidates){Agencies.query(function(users){var ballots=_.pluck(users,"ballot"),votes=_.flatten(ballots),count=_.countBy(votes);$scope.tally=[],_.forEach(count,function(count,id){id&&$scope.tally.push({candidateID:_.result(_.find(candidates,function(candidate){return candidate._id===id}),"prep_name"),count:count})})})})}]),angular.module("letters").factory("Agencies",["$resource",function($resource){return $resource("agency/:agencyId",{agencyId:"@username"},{update:{method:"PUT"}})}]),angular.module("letters").factory("Globals",["$resource",function($resource){return $resource("globals/:globalId/:controller",{globalId:"@_id"},{update:{method:"PUT"}})}]),angular.module("letters").factory("Articles",["$resource",function($resource){return $resource("articles/:articleId/:controller",{articleId:"@_id"},{update:{method:"PUT"}})}]),angular.module("users").config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push(["$q","$location","Authentication",function($q,$location,Authentication){return{responseError:function(rejection){switch(rejection.status){case 401:Authentication.user=null,$location.path("signin");break;case 403:}return $q.reject(rejection)}}}])}]),angular.module("users").config(["$stateProvider",function($stateProvider){$stateProvider.state("profile",{url:"/settings/profile/edit",templateUrl:"modules/users/views/settings/edit-profile.client.view.html"}).state("password",{url:"/settings/password",templateUrl:"modules/users/views/settings/change-password.client.view.html"}).state("signin",{url:"/signin",templateUrl:"modules/users/views/authentication/signin.client.view.html"}).state("forgot",{url:"/password/forgot",templateUrl:"modules/users/views/password/forgot-password.client.view.html"}).state("reset-invalid",{url:"/password/reset/invalid",templateUrl:"modules/users/views/password/reset-password-invalid.client.view.html"}).state("reset-success",{url:"/password/reset/success",templateUrl:"modules/users/views/password/reset-password-success.client.view.html"}).state("reset",{url:"/password/reset/:token",templateUrl:"modules/users/views/password/reset-password.client.view.html"})}]),angular.module("users").controller("AuthenticationController",["$scope","$http","$state","Authentication","vcRecaptchaService",function($scope,$http,$state,Authentication,vcRecaptchaService){$scope.user=Authentication.user,$scope.user&&$state.go("command"),$scope.signin=function(form){$scope.credentials.rcap=vcRecaptchaService.getResponse(),$scope.credentials.rcap&&$http.post("/auth/signin",$scope.credentials).success(function(response){Authentication.user=response,$scope.user=Authentication.user,$state.go(0===$scope.user.status?"command":"thanks")}).error(function(response){grecaptcha.reset(),$scope.error=response.message})}}]),angular.module("users").controller("PasswordController",["$scope","$stateParams","$http","$location","Authentication",function($scope,$stateParams,$http,$location,Authentication){$scope.authentication=Authentication,$scope.authentication.user&&$location.path("/"),$scope.askForPasswordReset=function(){$scope.success=$scope.error=null,$http.post("/auth/forgot",$scope.credentials).success(function(response){$scope.credentials=null,$scope.success=response.message}).error(function(response){$scope.credentials=null,$scope.error=response.message})},$scope.resetUserPassword=function(){$scope.success=$scope.error=null,$http.post("/auth/reset/"+$stateParams.token,$scope.passwordDetails).success(function(response){$scope.passwordDetails=null,Authentication.user=response,$location.path("/password/reset/success")}).error(function(response){$scope.error=response.message})}}]),angular.module("users").controller("SettingsController",["$scope","$http","$location","Users","Authentication",function($scope,$http,$location,Users,Authentication){$scope.user=Authentication.user,$scope.user||$location.path("/"),$scope.updateUserProfile=function(isValid){if(isValid){$scope.success=$scope.error=null;var user=new Users($scope.user);user.$update(function(response){$scope.success=!0,Authentication.user=response;var newPage=$scope.isFirstLogin?"/settings/profile":"/";$location.path(newPage)},function(response){$scope.error=response.data.message})}else $scope.submitted=!0},$scope.changeUserPassword=function(){$scope.success=$scope.error=null,$http.post("/users/password",$scope.passwordDetails).success(function(response){$scope.success=!0,$scope.passwordDetails=null}).error(function(response){$scope.error=response.message})}}]),angular.module("users").factory("Authentication",[function(){var _this=this;return _this._data={user:window.user},_this._data}]),angular.module("users").factory("Users",["$resource",function($resource){return $resource("users",{},{update:{method:"PUT"}})}]);